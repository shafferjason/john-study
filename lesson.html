<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lesson - Hurst Class Study</title>
    <!-- Updated CSS file with all UX enhancements -->
    <link rel="stylesheet" href="style.css?v=25">
</head>
<body>

    <div class="container">
        <div class="back-link">
            <a href="index.html">&larr; Back to All Lessons</a>
        </div>

        <article id="lesson-content">
        </article>

        <nav class="lesson-navigation">
        </nav>
    </div>

    <!-- Back-to-top button will be auto-injected here by JavaScript -->

    <script src="data.js"></script>
    <script>
        // Get the lesson ID from the URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        const lessonId = urlParams.get('id');

        // Find the lesson in the data
        const currentLesson = lessonData.find(lesson => lesson.id === lessonId);

        if (!currentLesson) {
            // Lesson not found
            document.getElementById('lesson-content').innerHTML = `
                <div class="error-message">
                    <h1>Lesson Not Found</h1>
                    <p>Sorry, we couldn't find the lesson you're looking for.</p>
                    <a href="index.html" class="button">Return to All Lessons</a>
                </div>
            `;
        } else {
            // Update page title
            document.title = currentLesson.title + ' - Hurst Class Study';

            // Extract lyrics preview (first 4 lines)
            let lyricsPreview = '';
            if (currentLesson.song_lyrics) {
                const lyricsLines = currentLesson.song_lyrics.split('\n');
                lyricsPreview = lyricsLines.slice(0, 4).join('\n');
            }

            // Build the lesson content
            const lessonContent = document.getElementById('lesson-content');
            
            lessonContent.innerHTML = `
                <header class="lesson-header">
                    <h1>${currentLesson.title}</h1>
                    <p class="scripture-reference">${currentLesson.scripture}</p>
                </header>

                <section class="lesson-summary">
                    <h2>Lesson at a Glance</h2>
                    <p class="preview-text">${currentLesson.summary_preview}</p>
                    <details class="accordion">
                        <summary>Read Full Lesson Summary</summary>
                        <div class="accordion-content">
                            <p>${currentLesson.summary_full}</p>
                        </div>
                    </details>
                </section>

                <!-- Ornate divider for visual section break -->
                <div class="divider-ornate"></div>

                <section class="song-tie-in">
                    <h2>Song Tie-in</h2>
                    <p class="preview-text">${currentLesson.tie_in_preview}</p>
                    <details class="accordion">
                        <summary>Read About the Song</summary>
                        <div class="accordion-content">
                            <p>${currentLesson.tie_in_full}</p>
                        </div>
                    </details>
                </section>

                <!-- Ornate divider before song section -->
                <div class="divider-ornate"></div>

                <section class="song-section">
                    <h2>${currentLesson.song_title}</h2>
                    
                    <!-- "A song by The Tenth Hour" with logo -->
                    <p class="song-attribution">
                        A song by The <img src="logo.svg" alt="Tenth Hour" class="inline-logo">
                    </p>
                    
                    ${currentLesson.image_url ? `<img src="${currentLesson.image_url}" alt="${currentLesson.song_title}" class="song-image">` : ''}
                    
                    ${currentLesson.audio_file ? `
                        <div class="custom-audio-player">
                            <audio id="lesson-audio" src="${currentLesson.audio_file}"></audio>
                            
                            <button id="play-pause-btn" class="player-button" aria-label="Play/Pause">
                                <svg class="play-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                                <svg class="pause-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="display:none;"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                            </button>
                            <div id="current-time" class="time-display">0:00</div>
                            <input type="range" id="seek-bar" class="seek-bar" value="0" min="0" max="100" aria-label="Audio seek bar">
                            <div id="duration" class="time-display">0:00</div>
                        </div>
                    ` : ''}
                    ${currentLesson.suno_link ? `
                        <p class="suno-link">
                            Can't play? <a href="${currentLesson.suno_link}" target="_blank" rel="noopener">Listen on Suno →</a>
                        </p>
                    ` : ''}
                    
                    ${currentLesson.song_lyrics ? `
                        <!-- Lyrics accordion below player -->
                        <details class="accordion lyrics-accordion">
                            <summary>View Song Lyrics</summary>
                            <div class="accordion-content lyrics-content">
                                <div class="lyrics-text">${currentLesson.song_lyrics}</div>
                            </div>
                        </details>
                    ` : ''}
                </section>
            `;

            // Build navigation links
            const currentIndex = lessonData.findIndex(lesson => lesson.id === lessonId);
            const navSection = document.querySelector('.lesson-navigation');
            
            let navHTML = '<div class="nav-links">';
            
            // Previous lesson link
            if (currentIndex > 0) {
                const prevLesson = lessonData[currentIndex - 1];
                navHTML += `
                    <a href="lesson.html?id=${prevLesson.id}" class="nav-link prev-link">
                        ← Previous Lesson: ${prevLesson.title}
                    </a>
                `;
            } else {
                navHTML += '<span class="nav-link-placeholder"></span>';
            }
            
            // Next lesson link
            if (currentIndex < lessonData.length - 1) {
                const nextLesson = lessonData[currentIndex + 1];
                navHTML += `
                    <a href="lesson.html?id=${nextLesson.id}" class="nav-link next-link">
                        Next Lesson: ${nextLesson.title} →
                    </a>
                `;
            } else {
                navHTML += '<span class="nav-link-placeholder"></span>';
            }
            
            navHTML += '</div>';
            navSection.innerHTML = navHTML;

            // === AUDIO PLAYER JAVASCRIPT ===
            // This code must run *after* the innerHTML is set
            if (currentLesson.audio_file) {
                const audio = document.getElementById('lesson-audio');
                const playPauseBtn = document.getElementById('play-pause-btn');
                const playIcon = playPauseBtn.querySelector('.play-icon');
                const pauseIcon = playPauseBtn.querySelector('.pause-icon');
                const seekBar = document.getElementById('seek-bar');
                const currentTimeEl = document.getElementById('current-time');
                const durationEl = document.getElementById('duration');
                const audioPlayer = document.querySelector('.custom-audio-player');

                // Helper function to format time in 0:00
                function formatTime(seconds) {
                    const minutes = Math.floor(seconds / 60);
                    const secs = Math.floor(seconds % 60);
                    return `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
                }

                // Play/Pause functionality
                playPauseBtn.addEventListener('click', () => {
                    if (audio.paused) {
                        audio.play();
                        playIcon.style.display = 'none';
                        pauseIcon.style.display = 'inline-block';
                        audioPlayer.classList.add('playing'); // Add fire effect
                    } else {
                        audio.pause();
                        playIcon.style.display = 'inline-block';
                        pauseIcon.style.display = 'none';
                        audioPlayer.classList.remove('playing'); // Remove fire effect
                    }
                });

                // Update seek bar and time as audio plays
                audio.addEventListener('timeupdate', () => {
                    seekBar.value = audio.currentTime; 
                    currentTimeEl.textContent = formatTime(audio.currentTime);
                });

                // Set total duration when audio loads
                audio.addEventListener('loadedmetadata', () => {
                    durationEl.textContent = formatTime(audio.duration);
                    seekBar.max = audio.duration; 
                    
                    // Set up Media Session API for lock screen/control center display
                    if ('mediaSession' in navigator) {
                        navigator.mediaSession.metadata = new MediaMetadata({
                            title: currentLesson.song_title,
                            artist: 'The Tenth Hour',
                            album: 'Hurst Class Study: Book of John',
                            artwork: [
                                { src: currentLesson.image_url, sizes: '512x512', type: 'image/jpeg' }
                            ]
                        });
                        
                        // Set up action handlers for media controls
                        navigator.mediaSession.setActionHandler('play', () => {
                            audio.play();
                            playIcon.style.display = 'none';
                            pauseIcon.style.display = 'inline-block';
                            audioPlayer.classList.add('playing');
                        });
                        
                        navigator.mediaSession.setActionHandler('pause', () => {
                            audio.pause();
                            playIcon.style.display = 'inline-block';
                            pauseIcon.style.display = 'none';
                            audioPlayer.classList.remove('playing');
                        });
                        
                        navigator.mediaSession.setActionHandler('seekbackward', () => {
                            audio.currentTime = Math.max(audio.currentTime - 10, 0);
                        });
                        
                        navigator.mediaSession.setActionHandler('seekforward', () => {
                            audio.currentTime = Math.min(audio.currentTime + 10, audio.duration);
                        });
                        
                        navigator.mediaSession.setActionHandler('seekto', (details) => {
                            if (details.seekTime) {
                                audio.currentTime = details.seekTime;
                            }
                        });
                    }
                });
                
                // Allow user to seek by dragging the bar
                seekBar.addEventListener('input', () => {
                    audio.currentTime = seekBar.value;
                });
                
                // Reset player when audio ends
                audio.addEventListener('ended', () => {
                    playIcon.style.display = 'inline-block';
                    pauseIcon.style.display = 'none';
                    seekBar.value = 0;
                    currentTimeEl.textContent = '0:00';
                    audioPlayer.classList.remove('playing'); // Remove fire effect
                });
            }
            // === END AUDIO PLAYER JAVASCRIPT ===
        }
        
        
        // === ONE-TIME SCROLL FADE-IN ===
        // Sections fade in once as you scroll down, then stay visible
        const fadeObserverOptions = {
            threshold: 0.15,
            rootMargin: '0px 0px -100px 0px'
        };
        
        const fadeObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                // Only add illuminate class if not already added
                if (entry.isIntersecting && !entry.target.classList.contains('illuminate')) {
                    entry.target.classList.add('illuminate');
                    // Stop observing this element (one-time only)
                    fadeObserver.unobserve(entry.target);
                }
            });
        }, fadeObserverOptions);
        
        // Observe all major sections
        document.querySelectorAll('.lesson-summary, .song-tie-in, .song-lyrics-section, .song-section').forEach(section => {
            section.classList.add('awaiting-light');
            fadeObserver.observe(section);
        });
        
        // Header is always visible immediately
        const header = document.querySelector('.lesson-header');
        if (header) {
            header.classList.add('illuminate');
        }
        // === END ONE-TIME SCROLL FADE-IN ===
        
        // === ACCORDION ANIMATION REPLAY ===
        // Force animations to replay every time accordion opens + smooth closing
        document.querySelectorAll('.accordion').forEach(accordion => {
            accordion.addEventListener('toggle', function(e) {
                const content = this.querySelector('.accordion-content');
                
                if (this.open) {
                    // MOBILE ONLY: Auto-close other main accordions (not lyrics accordion)
                    if (window.innerWidth <= 768) {
                        const isMainAccordion = this.closest('.lesson-summary, .song-tie-in') && !this.classList.contains('lyrics-accordion');
                        
                        if (isMainAccordion) {
                            // Scroll to this accordion FIRST to prevent jump
                            this.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            
                            // Find all other main accordions (excluding lyrics)
                            const mainAccordions = document.querySelectorAll('.lesson-summary .accordion, .song-tie-in .accordion:not(.lyrics-accordion)');
                            
                            mainAccordions.forEach(otherAccordion => {
                                if (otherAccordion !== this && otherAccordion.open) {
                                    // Close it smoothly
                                    otherAccordion.setAttribute('closing', '');
                                    setTimeout(() => {
                                        otherAccordion.removeAttribute('open');
                                        otherAccordion.removeAttribute('closing');
                                    }, 1600);
                                }
                            });
                        }
                    }
                    
                    // OPENING: Force animation replay with cascading
                    if (content) {
                        // Remove closing state if present
                        this.removeAttribute('closing');
                        
                        // Remove temporary class (forces browser to recalculate all child animations)
                        content.classList.add('no-animate');
                        
                        // Force reflow
                        void content.offsetWidth;
                        
                        // Remove the class (animations will restart with delays intact)
                        content.classList.remove('no-animate');
                    }
                } else {
                    // CLOSING: Fade out smoothly before actually closing
                    e.preventDefault(); // Prevent immediate close
                    
                    // Add closing state for animation
                    this.setAttribute('closing', '');
                    
                    // Wait for fade out animation, then actually close
                    setTimeout(() => {
                        this.removeAttribute('open');
                        this.removeAttribute('closing');
                    }, 1600); // Match accordionFadeOut duration (1.6s)
                }
            });
        });
        
        // === ADD CLOSE BUTTONS TO ACCORDION CONTENT (MOBILE ONLY) ===
        if (window.innerWidth <= 768) {
            document.querySelectorAll('.lesson-summary .accordion-content, .song-tie-in .accordion-content').forEach(content => {
                const closeBtn = document.createElement('button');
                closeBtn.className = 'accordion-close-btn';
                closeBtn.textContent = 'Close';
                closeBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const accordion = this.closest('.accordion');
                    if (accordion && accordion.open) {
                        // Scroll to the accordion's top BEFORE starting close animation
                        accordion.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        
                        // Small delay to let scroll start, then begin close animation
                        setTimeout(() => {
                            accordion.setAttribute('closing', '');
                            setTimeout(() => {
                                accordion.removeAttribute('open');
                                accordion.removeAttribute('closing');
                            }, 1600);
                        }, 100);
                    }
                });
                content.appendChild(closeBtn);
            });
        }
        // === END ACCORDION REPLAY ===
    </script>

</body>
</html>
